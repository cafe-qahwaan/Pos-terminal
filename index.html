<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Cafe Qahwaan ‚Äî POS</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    /* Palette (oak + coffee on beige) */
    --bg:#f6f1e6;
    --panel:#fffdf8;
    --ink:#2e251c;
    --muted:#7a6b5f;
    --line:#e7dbc8;
    --oak:#8a5a2e;         /* main oak tone */
    --oak-deep:#6e441e;
    --chip:#efeadf;
    --ok:#2fab73;
    --danger:#e25545;
    --blue:#1f8fff;
    --qs:#ff8a00;          /* Quick Sale highlight */
    --qs-deep:#ff6a00;
    --radius:16px;
    --shadow:0 10px 30px rgba(0,0,0,.06);
    --shadow-soft:0 6px 18px rgba(0,0,0,.05);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
  }

  /* Header */
  header{
    position:sticky; top:0; z-index:20;
    display:flex; align-items:center; gap:14px;
    padding:16px 18px;
    background:linear-gradient(180deg,#fff8ee,#fff4e3);
    border-bottom:1px solid var(--line);
  }
  header img{width:42px;height:42px;border-radius:10px}
  .brand{
    font-weight:900; letter-spacing:.3px;
    font-size:1.4rem;
    color:var(--oak);
    text-shadow:0 1px 0 #fff3;
  }

  /* Tables (previous Tabs) row */
  #tabsBar{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    padding:10px 18px; border-bottom:1px solid var(--line); background:#fffaf2;
  }
  .label{ color:var(--muted); font-weight:800; }
  .tabbtn{
    appearance:none; border:1px solid var(--line); background:#fff;
    color:var(--ink); padding:10px 14px; border-radius:14px; cursor:pointer;
    font-weight:800; box-shadow:var(--shadow-soft);
  }
  .tabbtn.active{ outline:2px solid var(--oak); background:#fff; }
  .tabbadge{ margin-left:6px; color:#246b2b; font-size:.85em }

  /* Quick sale: brighter + glow */
  #quickSaleBtn{
    margin-left:auto; padding:10px 16px;
    background:linear-gradient(180deg,var(--qs),var(--qs-deep));
    color:#fff; border:none; border-radius:14px; cursor:pointer;
    font-weight:900; letter-spacing:.2px; box-shadow:0 10px 18px #ff8a0050, inset 0 1px 0 #fff6;
  }

  /* Category chips (prominent) */
  .cats{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    padding:14px 18px;
  }
  .pill{
    background:var(--chip);
    border:1px solid var(--line);
    color:var(--oak-deep);
    padding:10px 14px;
    border-radius:999px;
    font-weight:900; cursor:pointer;
    box-shadow:var(--shadow-soft);
  }
  .pill.active{
    background:#fff;
    outline:2px solid var(--oak);
    color:var(--oak);
  }

  /* Layout */
  main{ display:grid; grid-template-columns:1.35fr .9fr; gap:16px; padding:0 18px 18px; }
  @media (max-width: 980px){ main{ grid-template-columns:1fr; } }

  /* Panels */
  .panel{
    background:var(--panel); border:1px solid var(--line); border-radius:var(--radius);
    padding:12px; box-shadow:var(--shadow-soft);
  }

  /* Menu grid */
  .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:12px; }
  .card{
    background:#fff; border:1px solid var(--line); border-radius:14px;
    padding:14px; min-height:120px; display:flex; flex-direction:column; justify-content:space-between;
    cursor:pointer; transition:transform .05s ease, box-shadow .1s ease;
    box-shadow:var(--shadow-soft);
  }
  .card:active{ transform:translateY(1px); box-shadow:var(--shadow); }
  .card-top{ display:flex; align-items:center; justify-content:space-between; gap:8px }
  .card-name{ font-weight:900; display:flex; align-items:center; gap:6px }
  .card-plus{
    width:28px;height:28px;border-radius:8px;border:1px solid var(--line); background:#fff; font-weight:800;
    display:grid; place-items:center; box-shadow:var(--shadow-soft);
  }
  .card-price{ color:var(--muted); font-weight:700; }

  /* Cart */
  .cart{ background:#ffffffcc; backdrop-filter: blur(4px); }
  .cart h3{ margin:0 0 10px; font-size:1.05rem }
  .cart-list{ border:1px dashed var(--line); border-radius:12px; background:#fff; }
  .row{
    display:grid; grid-template-columns:1fr auto auto auto; gap:8px; align-items:center;
    padding:10px 12px; border-bottom:1px dashed var(--line);
  }
  .row:last-child{ border-bottom:none }
  .qtychip{
    display:inline-flex; align-items:center; gap:8px; padding:6px 8px;
    border:1px solid var(--line); border-radius:999px; background:#fff;
  }
  .qtybtn{ width:26px;height:26px;border-radius:8px;border:1px solid var(--line); background:#fff; }
  .money{ font-weight:900 }
  .muted{ color:var(--muted) }

  .totals{ margin-top:12px; background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px }
  .tot-line{ display:flex; justify-content:space-between; padding:6px 0 }
  .tot-line strong{ font-size:1.05rem }

  .inputs{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:12px }
  select,input{ width:100%; padding:12px; border-radius:12px; border:1px solid var(--line); background:#fff; color:var(--ink) }

  .bar{ position:sticky; bottom:0; display:grid; grid-template-columns:1fr 1fr; gap:10px; padding-top:12px; background:transparent; }
  .btn{ width:100%; padding:12px 14px; border:none; border-radius:12px; font-weight:800; cursor:pointer; }
  .btn.ok{ background:var(--ok); color:#fff }
  .btn.danger{ background:var(--danger); color:#fff }
  .btn.primary{ background:var(--blue); color:#fff }

  .admin .title{ font-weight:900; margin-bottom:6px; color:var(--oak-deep) }
  .hint{ color:var(--muted); font-size:.92rem }

  #tabStatus{ color:var(--muted); margin-top:8px; font-weight:800 }
</style>
</head>
<body>

  <!-- Header -->
  <header>
    <img src="/logo.png" alt="Cafe">
    <div class="brand">Cafe Qahwaan ‚Äî POS</div>
  </header>

  <!-- Tables row (was Tabs) -->
  <div id="tabsBar">
    <span class="label">Tables:</span>
    <button class="tabbtn" data-spot="T1">T1</button>
    <button class="tabbtn" data-spot="T2">T2</button>
    <button class="tabbtn" data-spot="T3">T3</button>
    <button class="tabbtn" data-spot="T4">T4</button>
    <button class="tabbtn" data-spot="T5">T5</button>
    <button class="tabbtn" data-spot="T6">T6</button>
    <button class="tabbtn" data-spot="B1">B1</button>
    <button class="tabbtn" data-spot="B2">B2</button>
    <button id="quickSaleBtn">‚ö° Quick Sale</button>
  </div>

  <!-- Prominent category chips -->
  <div class="cats" id="pillBar"></div>

  <main>
    <!-- MENU GRID -->
    <section class="panel">
      <div id="grid" class="grid"></div>
    </section>

    <!-- RIGHT SIDE -->
    <section style="display:flex; flex-direction:column; gap:16px">
      <div class="panel cart">
        <h3>üß∫ Cart</h3>

        <div id="cartList" class="cart-list">
          <div class="muted" style="padding:12px">No items. Tap product cards to add.</div>
        </div>

        <div class="totals">
          <div class="tot-line"><span class="muted">Subtotal</span><span id="subtotal" class="money">¬£0.00</span></div>
          <div class="tot-line"><span class="muted">Change due</span><span id="change" class="money">¬£0.00</span></div>
        </div>

        <div class="inputs">
          <label>Payment method
            <select id="payment">
              <option>Cash</option><option>Card</option><option>Online</option>
            </select>
          </label>
          <label>Staff
            <input id="staff" placeholder="Name or initials">
          </label>

          <div>
            <div class="muted" style="margin-bottom:6px">Amount received</div>
            <div style="display:flex; gap:8px; margin-bottom:8px">
              <button type="button" class="btn" style="background:#fff;border:1px solid var(--line)" onclick="quickCash(50)">50</button>
              <button type="button" class="btn" style="background:#fff;border:1px solid var(--line)" onclick="quickCash(100)">100</button>
              <button type="button" class="btn" style="background:#fff;border:1px solid var(--line)" onclick="quickCash(500)">500</button>
            </div>
            <input id="received" type="number" step="0.01" placeholder="0.00">
          </div>
        </div>

        <div class="bar">
          <button class="btn danger" onclick="clearCart()">Clear cart</button>
          <button class="btn primary" onclick="finalizeOrQuick()">Finalize / Pay</button>
        </div>
        <div id="tabStatus">Mode: Quick Sale</div>
      </div>

      <div class="panel admin">
        <div class="title">‚öôÔ∏è Admin ‚Äî Update Price</div>
        <div class="hint">Pick an item and set a new price.</div>
        <div style="display:grid; grid-template-columns:1fr; gap:10px; margin-top:8px">
          <label>Item <select id="adminItem"></select></label>
          <label>New price <input id="adminPrice" type="number" step="0.01" placeholder="0.00"></label>
          <button class="btn ok" onclick="updatePrice()">Update</button>
        </div>
      </div>
    </section>
  </main>

<script>
/* ============ STATE ============ */
let menuData = {};          // {Category: [{id,name,price,sort}]}
let flatMenu = [];          // all items flat
let activeCategory = null;
let cart = [];

/* category -> emoji */
const ICONS = {
  teas: "‚òï",
  tea: "‚òï",
  parathas: "ü´ì",
  paratha: "ü´ì",
  eggs: "üç≥",
  channy: "ü•£",
  shakes: "ü•§",
  drinks: "ü•§",
  beverages: "ü•§",
  default: "‚Ä¢"
};

const money = n => "¬£"+Number(n||0).toFixed(2);

/* ============ MENU LOADING & UI ============ */
async function loadMenu(){
  const res = await fetch("/api/menu");
  if(!res.ok){ document.getElementById("grid").innerHTML="<div>Menu load failed</div>"; return; }
  menuData = await res.json();
  flatMenu = Object.values(menuData).flat().sort((a,b)=> (a.sort??999)-(b.sort??999) );
  const cats = Object.keys(menuData);
  activeCategory = cats[0] || null;
  renderPills(cats);
  renderGrid();
  fillAdminSelect();
}
function renderPills(cats){
  const bar = document.getElementById("pillBar"); bar.innerHTML="";
  cats.forEach(cat=>{
    const key = (cat||"").toLowerCase();
    const icon = ICONS[key] || ICONS.default;
    const b = document.createElement("button");
    b.className = "pill"+(cat===activeCategory?" active":"");
    b.innerHTML = `<span style="margin-right:6px">${icon}</span>${cat}`;
    b.onclick = ()=>{ activeCategory=cat; renderGrid(); };
    bar.appendChild(b);
  });
}
function filteredItems(){
  // No search; only the active category (or all if none)
  return activeCategory ? (menuData[activeCategory]||[]) : flatMenu;
}
function renderGrid(){
  const grid = document.getElementById("grid"); grid.innerHTML="";
  const items = filteredItems();
  const key = (activeCategory||"").toLowerCase();
  const catIcon = ICONS[key] || ICONS.default;

  items.forEach(it=>{
    const card = document.createElement("div");
    card.className="card";
    card.onclick = ()=>addToCart(it);
    card.innerHTML = `
      <div class="card-top">
        <div class="card-name"><span>${catIcon}</span>${it.name}</div>
        <div class="card-plus">+</div>
      </div>
      <div class="card-price">${money(it.price)}</div>
    `;
    grid.appendChild(card);
  });
}

function fillAdminSelect(){
  const sel = document.getElementById("adminItem"); sel.innerHTML="";
  flatMenu.forEach(it=>{
    const o=document.createElement("option"); o.value=it.id; o.textContent=`${it.name} (${money(it.price)})`;
    sel.appendChild(o);
  });
}

/* ============ CART ============ */
function renderCart(){
  const list = document.getElementById("cartList");
  list.innerHTML="";
  if(cart.length===0){
    list.innerHTML = `<div class="muted" style="padding:12px">No items. Tap product cards to add.</div>`;
  }else{
    cart.forEach(c=>{
      const row=document.createElement("div");
      row.className="row";
      row.innerHTML=`
        <div><strong>${c.name}</strong></div>
        <div class="money">${money(c.price*c.qty)}</div>
        <div class="qtychip">
          <button class="qtybtn" onclick="decItem(${c.id});event.stopPropagation()">‚Äì</button>
          <span style="min-width:20px;text-align:center;font-weight:800">${c.qty}</span>
          <button class="qtybtn" onclick="incItem(${c.id});event.stopPropagation()">+</button>
        </div>
        <div></div>`;
      list.appendChild(row);
    });
  }
  const t = cart.reduce((s,c)=>s+c.price*c.qty,0);
  document.getElementById("subtotal").textContent = money(t);
  const rec = Number(document.getElementById("received").value||0);
  document.getElementById("change").textContent = money(rec - t);
}
function addToCart(it){ const f=cart.find(c=>c.id==it.id); if(f) f.qty++; else cart.push({...it,qty:1}); renderCart(); cartChanged(); }
function incItem(id){ const f=cart.find(c=>c.id==id); if(f){f.qty++; renderCart(); cartChanged();} }
function decItem(id){ const f=cart.find(c=>c.id==id); if(!f) return; if(f.qty>1) f.qty--; else cart=cart.filter(c=>c.id!=id); renderCart(); cartChanged(); }
function clearCart(){ cart=[]; renderCart(); cartChanged(); }
function quickCash(n){ document.getElementById("received").value=n; renderCart(); }
document.getElementById("received").addEventListener("input", renderCart);

/* ============ ADMIN ============ */
async function updatePrice(){
  const id = document.getElementById("adminItem").value;
  const p  = Number(document.getElementById("adminPrice").value);
  if(!(p>=0)) return alert("Enter price");
  const r = await fetch("/api/update_price", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({id,new_price:p}) });
  if(r.ok){ alert("Updated"); loadMenu(); } else alert("Error: "+await r.text());
}

/* ============ PAY / FINALIZE ============ */
async function finalizeOrQuick(){
  if(cart.length===0) return alert("Cart empty");
  const staff = document.getElementById("staff").value.trim();
  if(!staff) return alert("Enter staff");
  const payment_method = document.getElementById("payment").value;
  const amount_received = Number(document.getElementById("received").value||0);

  if(currentTab){
    await saveTabNow();
    const r=await fetch("/api/tab/finalize",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ tab_id: currentTab.tab_id, payment_method, staff, amount_received }) });
    const txt=await r.text(); if(!r.ok){ alert("Finalize error: "+txt); return; }
    document.open(); document.write(txt); document.close();
  }else{
    const r=await fetch("/api/sale",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ cart, payment_method, staff, amount_received }) });
    const txt=await r.text(); if(!r.ok){ alert("Sale error: "+txt); return; }
    document.open(); document.write(txt); document.close();
  }
}

/* ============ TABLES (auto-save) ============ */
let currentTab=null; let saveTimer=null;

async function saveTabNow(){
  if(!currentTab) return;
  try{
    const res=await fetch("/api/tab/save",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ tab_id: currentTab.tab_id, spot: currentTab.spot, cart }) });
    const txt=await res.text(); if(!res.ok){ alert("Tab save error: "+txt); return; }
    refreshTabsBarBadges();
  }catch(e){ alert("Network error: "+e.message); }
}
function scheduleSave(){ if(!currentTab) return; if(saveTimer) clearTimeout(saveTimer); saveTimer=setTimeout(saveTabNow,300); }
function cartChanged(){ saveTabNow(); scheduleSave(); }

async function refreshTabsBarBadges(){
  try{
    const r=await fetch("/api/tabs"); if(!r.ok) return; const list=await r.json();
    const bySpot=new Map(list.map(t=>[t.spot,t]));
    document.querySelectorAll(".tabbtn").forEach(btn=>{
      const spot=btn.dataset.spot;
      btn.classList.toggle("active", currentTab && currentTab.spot===spot);
      const old=btn.querySelector(".tabbadge"); if(old) old.remove();
      const t=bySpot.get(spot);
      if(t && t.item_count>0){
        const b=document.createElement("span"); b.className="tabbadge"; b.textContent=`${t.item_count} ‚Ä¢ ¬£${(t.subtotal).toFixed(2)}`; btn.appendChild(b);
      }
    });
  }catch(_){}
}
function ensureArray(v){ if(Array.isArray(v)) return v; if(v==null) return []; try{const p=typeof v==="string"?JSON.parse(v):v; return Array.isArray(p)?p:[]}catch{return[]} }
async function selectSpot(spot){
  await saveTabNow();
  try{
    const r=await fetch("/api/tab/open",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ spot }) });
    if(!r.ok){ alert("Table open error"); return; }
    const t=await r.json();
    currentTab={ tab_id:t.tab_id, spot:t.spot };
    cart=ensureArray(t.cart);
    renderCart();
    document.getElementById("tabStatus").textContent=`Mode: Tab ${currentTab.spot}`;
    refreshTabsBarBadges();
  }catch(e){ alert("Network error: "+e.message); }
}

/* Quick Sale mode */
document.getElementById("quickSaleBtn").addEventListener("click", async ()=>{
  if(currentTab) await saveTabNow();
  currentTab=null; cart=[]; renderCart();
  document.getElementById("payment").value="Cash";
  document.getElementById("received").value="";
  document.getElementById("staff").value="";
  document.getElementById("tabStatus").textContent="Mode: Quick Sale";
  refreshTabsBarBadges();
});

/* Table clicks */
document.getElementById("tabsBar").addEventListener("click", e=>{
  const b=e.target.closest(".tabbtn"); if(!b) return; selectSpot(b.dataset.spot);
});

/* ============ BOOT ============ */
setInterval(refreshTabsBarBadges,20000);
refreshTabsBarBadges();
loadMenu();
renderCart();
</script>
</body>
</html>
