<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Cafe Qahwaan ‚Äî POS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: sans-serif; margin:0; background:#1e1e2f; color:#f5f5f5; }
    header { background:#111; padding:12px; display:flex; align-items:center; }
    header img { height:40px; margin-right:10px; border-radius:8px; }
    header h1 { margin:0; font-size:1.4em; color:#ff9933; }

    /* Tab bar */
    #tabsBar { display:flex;gap:6px;flex-wrap:wrap;padding:8px 10px;background:#0e0e15;border-bottom:1px solid #333 }
    .tabbtn{ background:#222;border:1px solid #444;color:#fff;border-radius:6px;padding:8px 10px;cursor:pointer }
    .tabbtn.active{ outline:2px solid #ff9933; }
    .tabbadge{ margin-left:6px;color:#9fd09f;font-size:.85em }

    main { display:flex; flex-wrap:wrap; }
    section { flex:1 1 50%; padding:10px; box-sizing:border-box; }
    h2 { margin-top:0; cursor:pointer; background:#333; padding:6px; border-radius:6px; }
    .items { display:none; margin-top:6px; }
    .items button { display:block; width:100%; padding:10px; margin:3px 0; background:#444; color:white; border:none; border-radius:6px; font-size:1em; }
    .items button:hover { background:#666; }
    .cart { background:#222; padding:10px; border-radius:8px; }
    .cart table { width:100%; font-size:0.9em; }
    .cart td, .cart th { padding:4px; }
    .total { font-size:1.2em; margin-top:10px; }
    input, select { padding:6px; margin:4px 0; width:100%; border-radius:4px; border:1px solid #555; background:#333; color:white; }
    button.action { padding:10px; margin-top:6px; width:48%; font-size:1em; border:none; border-radius:6px; }
    .submit { background:#28a745; color:white; }
    .clear { background:#dc3545; color:white; }
    .admin { margin-top:20px; background:#111; padding:10px; border-radius:8px; }
  </style>
</head>
<body>
  <header>
    <img src="/logo.png" alt="Cafe Qahwaan">
    <h1>Cafe Qahwaan ‚Äî POS</h1>
  </header>

  <!-- Tabs bar -->
  <div id="tabsBar">
    <strong style="margin-right:6px;color:#ff9933">Tabs:</strong>
    <button class="tabbtn" data-spot="T1">T1</button>
    <button class="tabbtn" data-spot="T2">T2</button>
    <button class="tabbtn" data-spot="T3">T3</button>
    <button class="tabbtn" data-spot="T4">T4</button>
    <button class="tabbtn" data-spot="T5">T5</button>
    <button class="tabbtn" data-spot="T6">T6</button>
    <button class="tabbtn" data-spot="B1">B1</button>
    <button class="tabbtn" data-spot="B2">B2</button>
    <span style="flex:1"></span>
    <button id="quickSaleBtn" style="background:#2b2b2b;color:#fff;border:1px solid #444;border-radius:6px;padding:8px 10px">Quick Sale</button>
  </div>

  <main>
    <section id="menu"><h2>Loading menu‚Ä¶</h2></section>
    <section>
      <div class="cart">
        <h2>üõí Cart</h2>
        <table id="cart"><tr><td>No items yet. Tap buttons on the left to add.</td></tr></table>
        <div class="total">Subtotal: <span id="subtotal">¬£0.00</span></div>
        <label>Payment method
          <select id="payment"><option>Cash</option><option>Card</option></select>
        </label>
        <label>Staff <input id="staff" placeholder="Name or initials"></label>
        <label>Amount received
          <div>
            <button type="button" onclick="quickCash(50)">50</button>
            <button type="button" onclick="quickCash(100)">100</button>
            <button type="button" onclick="quickCash(500)">500</button>
          </div>
          <input id="received" type="number" step="0.01">
        </label>
        <div class="total">Change due: <span id="change">¬£0.00</span></div>
        <div style="display:flex;justify-content:space-between">
          <button class="action submit" onclick="submitOrder()">Submit order</button>
          <button class="action clear" onclick="clearCart()">Clear cart</button>
        </div>
        <!-- New tab controls -->
        <div style="display:flex;justify-content:space-between;margin-top:6px">
          <button class="action" style="background:#444;color:#fff" onclick="saveTab()">Save (Hold)</button>
          <button class="action submit" style="background:#1f8fff" onclick="finalizeTab()">Finalize / Pay</button>
        </div>
        <div id="tabStatus" class="total" style="font-size:.95em;color:#bbb;margin-top:6px">Mode: Quick Sale</div>
      </div>

      <div class="admin">
        <h2>‚öôÔ∏è Admin ‚Äî Update Price</h2>
        <label>Item <select id="adminItem"></select></label>
        <label>New price <input id="adminPrice" type="number" step="0.01"></label>
        <button class="action submit" onclick="updatePrice()">Update</button>
      </div>
    </section>
  </main>

<script>
let menuData = [];
let cart = [];
const money = n => "¬£" + (Number(n||0).toFixed(2));

async function loadMenu(){
  const res = await fetch("/api/menu");
  menuData = await res.json();
  const menuDiv = document.getElementById("menu");
  menuDiv.innerHTML = "";
  Object.keys(menuData).forEach(cat=>{
    const h = document.createElement("h2");
    h.textContent = cat;
    h.onclick = () => { d.style.display = (d.style.display=="block"?"none":"block"); };
    menuDiv.appendChild(h);
    const d = document.createElement("div");
    d.className="items";
    menuData[cat].forEach(it=>{
      const b = document.createElement("button");
      b.textContent = it.name+" ‚Äì "+money(it.price);
      b.onclick = ()=>addToCart(it);
      d.appendChild(b);
    });
    menuDiv.appendChild(d);
  });

  // fill admin dropdown
  const sel = document.getElementById("adminItem");
  sel.innerHTML="";
  Object.values(menuData).flat().forEach(it=>{
    const o = document.createElement("option");
    o.value=it.id;
    o.textContent=it.name+" ("+money(it.price)+")";
    sel.appendChild(o);
  });
}

function addToCart(it){
  const found = cart.find(c=>c.id==it.id);
  if(found){ found.qty++; } else { cart.push({...it, qty:1}); }
  renderCart();
}

function renderCart(){
  const tbl = document.getElementById("cart");
  tbl.innerHTML="";
  if(cart.length==0){ tbl.innerHTML="<tr><td>No items.</td></tr>"; return; }
  cart.forEach(c=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${c.name}</td><td>${c.qty}</td>
      <td>${money(c.price*c.qty)}</td>
      <td><button onclick="decItem(${c.id})">-</button>
      <button onclick="incItem(${c.id})">+</button></td>`;
    tbl.appendChild(tr);
  });
  const t = cart.reduce((s,c)=>s+c.price*c.qty,0);
  document.getElementById("subtotal").textContent=money(t);
  const rec = Number(document.getElementById("received").value||0);
  document.getElementById("change").textContent=money(rec - t);
}

function incItem(id){ cart.find(c=>c.id==id).qty++; renderCart(); }
function decItem(id){ const f=cart.find(c=>c.id==id); if(f.qty>1)f.qty--; else cart=cart.filter(c=>c.id!=id); renderCart(); }
function clearCart(){ cart=[]; renderCart(); }
function quickCash(n){ document.getElementById("received").value=n; renderCart(); }

async function submitOrder(){
  if(cart.length==0){ alert("Cart empty"); return; }
  const body = {
    cart,
    payment_method: document.getElementById("payment").value,
    staff: document.getElementById("staff").value.trim(),
    amount_received: Number(document.getElementById("received").value || 0)
  };
  if(!body.staff){ alert("Enter staff"); return; }

  try{
    const res = await fetch("/api/sale", {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    if(!res.ok){ const t = await res.text(); alert("Error saving: " + t); return; }
    const html = await res.text();
    document.open(); document.write(html); document.close();
  }catch(err){ alert("Network error: " + err.message); }
}

async function updatePrice(){
  const id = document.getElementById("adminItem").value;
  const p = Number(document.getElementById("adminPrice").value);
  if(!p) return alert("Enter price");
  const res = await fetch("/api/update_price",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id,new_price:p})});
  if(res.ok){ alert("Updated"); loadMenu(); } else alert("Error");
}

document.getElementById("received").addEventListener("input",renderCart);

// ====== TAB LOGIC ======
let currentTab = null; // { tab_id, spot }

async function refreshTabsBarBadges(){
  try{
    const r = await fetch('/api/tabs');
    if(!r.ok) return;
    const list = await r.json();
    const bySpot = new Map(list.map(t=>[t.spot, t]));
    document.querySelectorAll('.tabbtn').forEach(btn=>{
      const spot = btn.dataset.spot;
      btn.classList.toggle('active', currentTab && currentTab.spot===spot);
      const old = btn.querySelector('.tabbadge'); if(old) old.remove();
      const t = bySpot.get(spot);
      if(t && t.item_count>0){
        const b = document.createElement('span');
        b.className = 'tabbadge';
        b.textContent = `${t.item_count} ‚Ä¢ ¬£${(t.subtotal).toFixed(2)}`;
        btn.appendChild(b);
      }
    });
  }catch(_){}
}

async function selectSpot(spot){
  try{
    const r = await fetch('/api/tab/open', {
      method: 'POST', headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ spot })
    });
    if(!r.ok){ alert('Tab open error'); return; }
    const t = await r.json();
    currentTab = { tab_id: t.tab_id, spot: t.spot };
    cart = Array.isArray(t.cart) ? t.cart : [];
    renderCart();
    document.getElementById('tabStatus').textContent = `Mode: Tab ${currentTab.spot}`;
    refreshTabsBarBadges();
  }catch(e){ alert('Network error: '+e.message); }
}

async function saveTab(){
  if(!currentTab){ alert('Pick a tab first'); return; }
  try{
    const r = await fetch('/api/tab/save', {
      method: 'POST', headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ tab_id: currentTab.tab_id, cart })
    });
    if(!r.ok){ alert('Save failed'); return; }
    alert('Saved on hold ‚úì');
    refreshTabsBarBadges();
  }catch(e){ alert('Network error: '+e.message); }
}

async function finalizeTab(){
  if(!currentTab){ alert('Pick a tab first'); return; }
  if(cart.length===0){ alert('Cart empty'); return; }
  const body = {
    tab_id: currentTab.tab_id,
    payment_method: document.getElementById('payment').value,
    staff: document.getElementById('staff').value.trim(),
    amount_received: Number(document.getElementById('received').value || 0)
  };
  if(!body.staff){ alert('Enter staff'); return; }
  try{
    const r = await fetch('/api/tab/finalize', {
      method: 'POST', headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    if(!r.ok){ const t = await r.text(); alert('Finalize error: '+t); return; }
    const html = await r.text();
    document.open(); document.write(html); document.close();
  }catch(e){ alert('Network error: '+e.message); }
}

// Quick Sale mode
document.getElementById('quickSaleBtn').addEventListener('click', ()=>{
  currentTab = null;
  document.getElementById('tabStatus').textContent = 'Mode: Quick Sale';
  refreshTabsBarBadges();
});

// Tab button clicks
document.getElementById('tabsBar').addEventListener('click', e=>{
  const btn = e.target.closest('.tabbtn'); if(!btn) return;
  selectSpot(btn.dataset.spot);
});

// refresh badges every 20s
setInterval(refreshTabsBarBadges, 20000);
refreshTabsBarBadges();

loadMenu();
</script>
</body>
</html>
